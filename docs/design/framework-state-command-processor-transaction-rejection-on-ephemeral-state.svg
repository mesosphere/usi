<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="607px" preserveAspectRatio="none" style="width:602px;height:607px;" version="1.1" viewBox="0 0 602 607" width="602px" zoomAndPan="magnify"><defs><filter height="300%" id="f14c17950ejk88" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="28" x2="28" y1="38.4883" y2="566.6309"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="190" x2="190" y1="38.4883" y2="566.6309"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="382" x2="382" y1="38.4883" y2="566.6309"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="546" x2="546" y1="38.4883" y2="566.6309"/><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="36" x="8" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="22" x="15" y="23.5352">API</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="36" x="8" y="565.6309"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="22" x="15" y="586.166">API</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="112" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="119" y="23.5352">CommandProcessor</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="112" y="565.6309"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="119" y="586.166">CommandProcessor</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="205" x="278" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="191" x="285" y="23.5352">CommandProcessorStorage</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="205" x="278" y="565.6309"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="191" x="285" y="586.166">CommandProcessorStorage</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="497" y="3"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="504" y="23.5352">Subscribers</text><rect fill="#FEFECE" filter="url(#f14c17950ejk88)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="497" y="565.6309"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="504" y="586.166">Subscribers</text><polygon fill="#A80036" points="178,81.1094,188,85.1094,178,89.1094,182,85.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="28" x2="184" y1="85.1094" y2="85.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="35" y="65.0566">Transaction 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="35" y="80.3672">Delete Instance A</text><polygon fill="#FBFB77" filter="url(#f14c17950ejk88)" points="130,98.1094,249,98.1094,259,117.1094,249,136.1094,130,136.1094,120,117.1094,130,98.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="132" y="114.6777">Validate and apply</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="62" x="132" y="129.9883">command</text><polygon fill="#A80036" points="370.5,159.041,380.5,163.041,370.5,167.041,374.5,163.041" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="190" x2="376.5" y1="163.041" y2="163.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="197" y="158.2988">Instance A deleted</text><polygon fill="#A80036" points="178,218.9727,188,222.9727,178,226.9727,182,222.9727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="28" x2="184" y1="222.9727" y2="222.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93" x="35" y="187.6094">Transaction 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="35" y="202.9199">Increment incarnation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="35" y="218.2305">for Instance A</text><polygon fill="#FBFB77" filter="url(#f14c17950ejk88)" points="98,235.9727,281,235.9727,291,277.9727,281,319.9727,98,319.9727,88,277.9727,98,235.9727" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="169" x="100" y="252.541">Unpersisted state does not</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="100" y="267.8516">have Instance A; transaction</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="100" y="283.1621">rejected by in-memory state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="100" y="298.4727">and not currently-persisted</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="100" y="313.7832">state.</text><polygon fill="#A80036" points="370.5,342.8359,380.5,346.8359,370.5,350.8359,374.5,346.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="190" x2="376.5" y1="346.8359" y2="346.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="197" y="342.0938">Transaction 2 failed</text><polygon fill="#FBFB77" filter="url(#f14c17950ejk88)" points="299,359.8359,465,359.8359,475,378.8359,465,397.8359,299,397.8359,289,378.8359,299,359.8359" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="301" y="376.4043">Update storage to remove</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="301" y="391.7148">instance A</text><polygon fill="#FBFB77" filter="url(#f14c17950ejk88)" points="304,408.457,461,408.457,471,450.457,461,492.457,304,492.457,294,450.457,304,408.457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="306" y="425.0254">Nothing to store for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="306" y="440.3359">transaction 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="310" y="455.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="306" y="470.957">We preserve the order of</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="306" y="486.2676">events</text><polygon fill="#A80036" points="534,515.3203,544,519.3203,534,523.3203,538,519.3203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382.5" x2="540" y1="519.3203" y2="519.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="389.5" y="514.5781">Instance A deleted</text><polygon fill="#A80036" points="534,544.6309,544,548.6309,534,552.6309,538,548.6309" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="382.5" x2="540" y1="548.6309" y2="548.6309"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="389.5" y="543.8887">Transaction 2 failed</text><!--
@startuml
Participant API
Participant CommandProcessor
Participant CommandProcessorStorage
Participant Subscribers

API -> CommandProcessor: **Transaction 1**\nDelete Instance A
hnote over CommandProcessor
  Validate and apply
  command
end hnote

CommandProcessor -> CommandProcessorStorage: Instance A deleted

API -> CommandProcessor: **Transaction 2**\nIncrement incarnation\nfor Instance A
hnote over CommandProcessor
  Unpersisted state does not
  have Instance A; transaction
  rejected by in-memory state
  and not currently-persisted
  state.
end hnote

CommandProcessor -> CommandProcessorStorage: Transaction 2 failed
hnote over CommandProcessorStorage
  Update storage to remove
  instance A
end hnote

hnote over CommandProcessorStorage
  Nothing to store for
  transaction 2

  We preserve the order of
  events
end hnote

CommandProcessorStorage -> Subscribers: Instance A deleted
CommandProcessorStorage -> Subscribers: Transaction 2 failed
@enduml

PlantUML version 1.2018.13(Mon Nov 26 10:11:51 MST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_162-b12
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>